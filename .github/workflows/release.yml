name: ðŸš€ Release Phone Apps

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  validate-and-release:
    name: ðŸ” Validate & Release
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck jq lua5.4 zip

      - name: ðŸ” Run Validation
        run: |
          chmod +x validate_phone_apps.sh
          ./validate_phone_apps.sh

      - name: ðŸ“¦ Prepare Release Package
        run: |
          # Create release directory
          mkdir -p release/phone_apps

          # Copy all necessary files
          cp -r shared/ release/phone_apps/
          cp -r invoicing/ release/phone_apps/
          cp -r notes/ release/phone_apps/
          cp -r business_cards/ release/phone_apps/
          cp -r calculator/ release/phone_apps/
          cp -r gallery/ release/phone_apps/
          cp install.sh release/phone_apps/
          cp validate_phone_apps.sh release/phone_apps/
          cp README_STANDALONE.md release/phone_apps/README.md
          cp LB_PHONE_SETUP.md release/phone_apps/
          cp .luarc.json release/phone_apps/

          # Make scripts executable
          chmod +x release/phone_apps/install.sh
          chmod +x release/phone_apps/validate_phone_apps.sh

          # Create version info
          echo "# ðŸ“± FiveM Phone Apps - Release Information" > release/phone_apps/VERSION.md
          echo "" >> release/phone_apps/VERSION.md
          echo "**Version:** ${GITHUB_REF_NAME:-${{ github.event.inputs.version }}}" >> release/phone_apps/VERSION.md
          echo "**Release Date:** $(date)" >> release/phone_apps/VERSION.md
          echo "**Commit:** ${GITHUB_SHA}" >> release/phone_apps/VERSION.md
          echo "" >> release/phone_apps/VERSION.md
          echo "## ðŸ“± Apps Included" >> release/phone_apps/VERSION.md
          echo "- ðŸ“§ Invoicing App (1024 KB)" >> release/phone_apps/VERSION.md
          echo "- ðŸ“ Notes App (512 KB)" >> release/phone_apps/VERSION.md
          echo "- ðŸ’¼ Business Cards App (768 KB)" >> release/phone_apps/VERSION.md
          echo "- ðŸ§® Calculator App (256 KB)" >> release/phone_apps/VERSION.md
          echo "- ðŸ“¸ Gallery App (1536 KB)" >> release/phone_apps/VERSION.md
          echo "" >> release/phone_apps/VERSION.md
          echo "## ðŸ”§ Compatibility" >> release/phone_apps/VERSION.md
          echo "- âœ… ESX Framework" >> release/phone_apps/VERSION.md
          echo "- âœ… QBCore Framework" >> release/phone_apps/VERSION.md
          echo "- âœ… QBX Framework" >> release/phone_apps/VERSION.md
          echo "- âœ… LB Phone System" >> release/phone_apps/VERSION.md
          echo "- âœ… QB Phone System" >> release/phone_apps/VERSION.md
          echo "- âœ… QS Smartphone System" >> release/phone_apps/VERSION.md

      - name: ðŸ“¦ Create ZIP Archive
        run: |
          cd release
          zip -r "fivem-phone-apps-${GITHUB_REF_NAME:-${{ github.event.inputs.version }}}.zip" phone_apps/
          cd ..

      - name: ðŸ“Š Generate Release Notes
        run: |
          echo "# ðŸ“± FiveM Phone Apps Release ${GITHUB_REF_NAME:-${{ github.event.inputs.version }}}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸŽ‰ What's Included" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "This release includes **5 universal phone apps** compatible with multiple frameworks and phone systems:" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### ðŸ“± Apps" >> RELEASE_NOTES.md
          echo "- **ðŸ“§ Invoicing App** (1024 KB) - Professional invoice management" >> RELEASE_NOTES.md
          echo "- **ðŸ“ Notes App** (512 KB) - Personal note-taking with categories" >> RELEASE_NOTES.md
          echo "- **ðŸ’¼ Business Cards App** (768 KB) - Professional card creator" >> RELEASE_NOTES.md
          echo "- **ðŸ§® Calculator App** (256 KB) - Advanced calculator with history" >> RELEASE_NOTES.md
          echo "- **ðŸ“¸ Gallery App** (1536 KB) - Photo storage and management" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### ðŸ”§ Framework Compatibility" >> RELEASE_NOTES.md
          echo "- âœ… **ESX** (es_extended)" >> RELEASE_NOTES.md
          echo "- âœ… **QBCore** (qb-core)" >> RELEASE_NOTES.md
          echo "- âœ… **QBX** (qbx_core)" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### ðŸ“± Phone System Compatibility" >> RELEASE_NOTES.md
          echo "- âœ… **LB Phone** (lb-phone)" >> RELEASE_NOTES.md
          echo "- âœ… **QB Phone** (qb-phone)" >> RELEASE_NOTES.md
          echo "- âœ… **QS Smartphone** (qs-smartphone)" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸš€ Quick Installation" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "1. Download and extract the ZIP file" >> RELEASE_NOTES.md
          echo "2. Copy the \`phone_apps\` folder to your server resources" >> RELEASE_NOTES.md
          echo "3. Run \`./install.sh\` to set up everything automatically" >> RELEASE_NOTES.md
          echo "4. Add the apps to your \`server.cfg\`" >> RELEASE_NOTES.md
          echo "5. Restart your server" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ“š Documentation" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "- ðŸ“– **README.md** - Complete setup and usage guide" >> RELEASE_NOTES.md
          echo "- ðŸ“± **LB_PHONE_SETUP.md** - Detailed LB Phone integration" >> RELEASE_NOTES.md
          echo "- ðŸ” **validate_phone_apps.sh** - Validation script" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## âœ… Quality Assurance" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "This release has been thoroughly validated:" >> RELEASE_NOTES.md
          echo "- âœ… All 5 apps pass comprehensive validation" >> RELEASE_NOTES.md
          echo "- âœ… Universal framework compatibility verified" >> RELEASE_NOTES.md
          echo "- âœ… Multi-phone system support tested" >> RELEASE_NOTES.md
          echo "- âœ… Code quality standards met" >> RELEASE_NOTES.md
          echo "- âœ… Security checks passed" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ› Support" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "If you encounter any issues:" >> RELEASE_NOTES.md
          echo "1. Run the validation script: \`./validate_phone_apps.sh\`" >> RELEASE_NOTES.md
          echo "2. Check the console for error messages" >> RELEASE_NOTES.md
          echo "3. Verify your framework and phone system are properly installed" >> RELEASE_NOTES.md
          echo "4. Review the documentation for troubleshooting tips" >> RELEASE_NOTES.md

      - name: ðŸš€ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name || github.event.inputs.version }}
          name: 'ðŸ“± FiveM Phone Apps ${{ github.ref_name || github.event.inputs.version }}'
          body_path: RELEASE_NOTES.md
          files: |
            release/fivem-phone-apps-*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ Post-Release Summary
        run: |
          echo "ðŸŽ‰ Release completed successfully!"
          echo "ðŸ“¦ Package: fivem-phone-apps-${GITHUB_REF_NAME:-${{ github.event.inputs.version }}}.zip"
          echo "ðŸ“± Apps included: 5 universal phone apps"
          echo "ðŸ”§ Framework support: ESX, QBCore, QBX"
          echo "ðŸ“± Phone support: LB Phone, QB Phone, QS Smartphone"
          echo "âœ… All validation checks passed"
